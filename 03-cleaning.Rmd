# Data transformation

We are working around three dataset in total, that is, titles.basics, title.crew, title.ratings. Therefore, it was very necessary to transformation the individual overall datasets by merging different datasets, adding new columns or removing the ones that were not needed or that had any NULL values.<br/><br/>

Below, we describe the transformations that we incorporated which were necessary to accomplish the results of different questions.<br/><br/>

```{r}
library(tidyverse)
library(patchwork)
library(reshape2)
library(dplyr)
library(ggplot2)
```

## Transformations to study distribution trends in Adult v/s Non-Adult titles

<br/>This question basically addresses two objectives.<br/>
- The first part studies the trend of number of adult title releases with the change of time.<br/>
- The second part studies the proportion of votes distribution of adult versus non-adult titles over the given period of time.<br/>
For this question, we primarily use the title.basics and title.ratings dataset. Therefore, we will initially prepare a new auxiliary dataframe which contains transformed version of these datasets.<br/>

### Adult title releases trends

<br/> In this part of the first objective question we wish to observe that with progressing years, did the film industry started making more adults, or less adults, or was the number of releases constant. The following steps show a detailed explanation on how we transformed the data step by step:<br/>
- Among all the columns available in the title.basics dataset, we are only interested in using the 'startYear' and 'isAdult' columns to achieve the first part of the first objective question. Thus, we dropped the other available columns in the data which were unnecessary for our exploration, likewise, 'primaryTitle', 'originalTitle', 'endYear', 'runtimeMinutes' and formed a new auxiliary dataframe named 'basics_ratings'.<br/>
- Further, as mentioned earlier, we need the necessary information('startYear' and 'isAdult') from title.basics, which basically is the basics_ratings dataframe, and title.ratings data combined in one auxiliary dataframe. So, we merge the title.ratings dataset with the basics_ratings dataframe and use to address both first and second part of the first objective question.<br/>
-Moreover, we analyzed that there were missing values in the 'isAdult' and 'startYear' columns. As we are going to explore that with the progress of year does the number of adult movies released had any trend or not, so we need to remove the start years values that have NULL. Also, we are summing up the total number of adult titles released per year, therefore, it is necessary to delete the rows that have NA values for isAdult. Thus, we dropped the rows which either contained NULL values for startYear or NULL values for isAdult.<br/>
- After cleaning the data by adding, removing and merging the columns, the next step is to group similar start years together and calculate the total number of adult titles that were released in that particular year. For this grouping operation to execute, we converted the datatype of both 'startYear ' and 'isAdult' columns to numeric. Once the datatype was transformed in the desired format, we grouped similar years together based on two different conditions:<br/>
  -Grouped same years and calculated the sum of the isAdult column which gave the total number of         adult titles released in a particular year. We assigned this to a new temporary dataframe. <br/>
  -Grouped same years and counted the number of rows of the isAdult column which gave the total number    of titles released in a particular in a particular year irrespective of adult or non-adult. We        assigned this to another new temporary dataframe.<br/>
Finally, we merged the above two temporary dataframes into one by the grouped start years.<br/>
- As the last step, we calculated the proportion of the adult titles released per start year. This percent would then be used to plot it against their respective start years and study the trend.<br/><br/>


```{r}
drops <- c("primaryTitle","originalTitle","endYear", "runtimeMinutes")
basics_ratings <- basics[ , !(names(basics) %in% drops)]
```

```{r}
basics_ratings <- merge(basics_ratings, ratings, by="tconst")
head(basics_ratings)
```

```{r}
basics_ratings_crew <- merge(basics_ratings, crew, by = "tconst")
head(basics_ratings_crew)
```

```{r}
byDirectors <- merge(basics_ratings_crew, names, by.x = "directors", by.y = "nconst")
byDirectors
```

```{r}
basics_ratings <- basics_ratings %>% drop_na(isAdult)
basics_ratings <- basics_ratings %>% drop_na(startYear)
```

```{r}
basics_ratings$startYear <- as.numeric(basics_ratings$startYear)
basics_ratings$isAdult <- as.numeric(basics_ratings$isAdult)
b1 <- basics_ratings %>% group_by(startYear) %>% summarise(isAdult = sum(isAdult))
b2 <- basics_ratings %>% group_by(startYear) %>% summarise(cnt = n())
b_final <- merge(b1, b2, by="startYear")
b_final$adult_proportion <- (b_final$isAdult / b_final$cnt) * 100
```

### Ratings distribution of non-adult vs adult titles
```{r}
b_0 <- filter(basics_ratings, isAdult == 0)
b_1 <- filter(basics_ratings, isAdult == 1)

b_0_0 <- b_0 %>% group_by(startYear) %>% summarise(numVotes = sum(numVotes))
b_1_1 <- b_1 %>% group_by(startYear) %>% summarise(numVotes = sum(numVotes))

b_num_votes <- merge(b_0_0, b_1_1, by = 'startYear', all = TRUE)
b_num_votes[is.na(b_num_votes)] <- 0

b_num_votes$non_adult <- as.matrix(b_num_votes[2] / rowSums(b_num_votes[2:3])) * 100
b_num_votes$adult <- as.matrix(b_num_votes[3] / rowSums(b_num_votes[2:3])) * 100
```

<br/><br/>
In this part of the first objective question, we are basically studying that did the non-adult titles released more percentages of votes, or less percentages of votes, or same as compared to the votes received by the adult titles in particular year. The following steps explains the transformations that we followed:<br/>
- First, we filtered out the rows from the basics_ratings dataset that had information about the non-adult titles and stored them in a new temporary auxiliary dataframe. Similarily, we filtered out the rows from the basics_ratings dataset that had information about the adult titles and stored them in another new temporary auxiliary dataframe.<br/>
- Further, we merged the above two temporary dataframes together into one based on similar start years and calculated the sum of the number of votes that were received by non adult and adult titles respectively. These two sums were basically created as two different new columns.<br/>
- Next we merged the above two columns based on start year to form a new transformed dataframe. Moreover, while merging there was a case when there would be some years which were not present in non adult titles or vice versa. So, performed a detailed transformation that included the start years from both the columns and not just the common years. In this situation, the rows that would result in NA values for the number of votes were transformed to get replaced by 0.<br/>
- Finally, we calculated a new column 'non-adult' in the merged dataframe above that contained the proportion of titles that were non-adult type for the particular year. Similarly, we created another new column in the merged dataframe above that contained the proportion of titles that were adult type for that particular year. These two columns would be used to plot against the start year and study that among the total votes received per year, how much percentage of votes were for non-adult titles and how much were for adult.<br/>


```{r}
# 178999 unique directors
# 10 unique title types
groupedDirec <- byDirectors %>%
    group_by(directors, primaryName, titleType, startYear) %>%
    summarise(weigthedRating = sum(averageRating * numVotes) / sum(numVotes))
groupedDirec
write.csv(last100years_GroupedDirecs,"sources_short/GroupedDirecs.csv", row.names = FALSE)

# 143 years
# 178983 unique directors
# 10 unique title types
groupedDirec_complete <- na.omit(groupedDirec)
length(unique(groupedDirec_complete$titleType))
groupedDirec_complete
write.csv(last100years_GroupedDirecs,"sources_short/GroupedDirecs_complete.csv", row.names = FALSE)
```
```{r}
# type = "movie"
# dRSub <- groupedDirec_complete[which(groupedDirec_complete$titleType == type), ]
# dRSub


for(type in unique(groupedDirec_complete$titleType)) {
  print(type)
  dRSub <- groupedDirec_complete[which(groupedDirec_complete$titleType == type), ]
  filename = paste0("sources_short/titletypes/",type,".csv")
  write.csv(dRSub, filename, row.names = FALSE)
}
```



```{r}
#4(A)
df1 <- basics_ratings_crew[!is.na(basics_ratings_crew$writers),]
df1 <- df1[!is.na(df1$directors),]

df1$director_writer_pair <- paste(df1$directors,"-", df1$writers)
tt <- df1 %>% count(director_writer_pair, sort = TRUE)
ttt <- c(tt[1:10,1])
df2 <- subset(df1, director_writer_pair %in% ttt)

#4(B)
temp1 <- group_by(df1, director_writer_pair, titleType, genres)
temp2 <- summarise(temp1, totalVotes = sum(numVotes))
df3 <- summarise(temp1, weightedRating = sum(averageRating * numVotes) / sum(numVotes))

temp3 <- df3 %>% right_join(temp2, by=c("director_writer_pair","titleType", "genres"))

df3_filtered <- filter(temp3, weightedRating == 10)
new_df3_filter <- merge(df3_filtered, tt, by = 'director_writer_pair')
new_filter <- filter(new_df3_filter, n >= 5)
```

```{r}
tttt <- df1 %>%
    group_by(director_writer_pair) %>%
    summarise(weigthedRating = sum(averageRating * numVotes) / sum(numVotes))

t_final <- merge(tttt, tt, by = 'director_writer_pair')
t_final <- t_final[with(t_final, order(-n, -weigthedRating)), ]
```

```{r}
# last20years <- df1[which(strtoi(df1$startYear) >= '2000'), ]
# last20years
# write.csv(last20years,"sources/last20years.csv", row.names = FALSE)
```

```{r}
# last100years <- df1[which(strtoi(df1$startYear) >= '1900'), ]
# last100years
# write.csv(last20years,"sources_short/last100years.csv", row.names = FALSE)
```


```{r}
tttt <- last100years %>%
    group_by(director_writer_pair, primaryName, writers) %>%
    summarise(weightedRating = sum(averageRating * numVotes) / sum(numVotes))
tttt
t_final <- merge(tttt, tt, by = 'director_writer_pair')
t_final <- t_final[with(t_final, order(-n, -weightedRating)), ]
t_final
```

```{r}
# directorRatings <- last20years %>%
#      group_by(primaryName, startYear) %>%
#      summarise(weightedRating = sum(averageRating * numVotes) / sum(numVotes))
# directorRatings$fileName = gsub("\\s", "_", directorRatings$primaryName)
# unique(directorRatings$primaryName)
# write.csv(directorRatings,"sources_short/directors/directorRatings.csv", row.names = FALSE)
```

```{r}
# director <-  "Alan J.W. Bell"
# dRSub <- directorRatings[which(directorRatings$primaryName == director), ]
# dRSub
# paste0(director,"_Rangints")
# 
# for(director in directorRatings$fileName) {
#    dRSub <- directorRatings[which(directorRatings$fileName == director), ]
#    filename = paste0("sources_short/directors/",director,"_Ratings.csv")
#    write.csv(dRSub, filename, row.names = FALSE)
# }
```
