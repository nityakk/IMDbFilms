# Data transformation


```{r}
library(tidyverse)
library(patchwork)
library(reshape2)
library(dplyr)
```

```{r}
basics_ratings <- merge(basics, ratings, by="tconst")
head(basics_ratings)
```

```{r}
basics_ratings_crew <- merge(basics_ratings, crew, by = "tconst")
head(basics_ratings_crew)
```

```{r}
byDirectors <- merge(basics_ratings_crew, names, by.x = "directors", by.y = "nconst")
head(byDirectors)
```

```{r}
basics_ratings <- basics_ratings[,c(5,6,10,11)]
basics_ratings$startYear <- as.numeric(basics_ratings$startYear)
basics_ratings$isAdult <- as.numeric(basics_ratings$isAdult)
basics_ratings <- basics_ratings %>% drop_na(startYear)
```

```{r}
b1 <- basics_ratings %>% group_by(startYear) %>% summarise(isAdult = sum(isAdult))
b2 <- basics_ratings %>% group_by(startYear) %>% summarise(cnt = n()) %>% mutate(freq = round(cnt / sum(cnt), 3)) %>% arrange(desc(freq))
b2 <- b2[,c(1,2)]
b_final <- merge(b1, b2, by="startYear")
b_final$adult_proportion <- (b_final$isAdult / b_final$cnt) * 100
```

```{r}
b_0 <- filter(basics_ratings, isAdult == 0)
b_1 <- filter(basics_ratings, isAdult == 1)

b_0_0 <- b_0 %>% group_by(startYear) %>% summarise(numVotes = sum(numVotes))
b_1_1 <- b_1 %>% group_by(startYear) %>% summarise(numVotes = sum(numVotes))

b_num_votes <- merge(b_0_0, b_1_1, by = 'startYear', all = TRUE)
b_num_votes[is.na(b_num_votes)] <- 0

b_num_votes$non_adult <- as.matrix(b_num_votes[2] / rowSums(b_num_votes[2:3])) * 100
b_num_votes$adult <- as.matrix(b_num_votes[3] / rowSums(b_num_votes[2:3])) * 100
```

```{r}
t2 <- byDirectors %>%
    group_by(directors, titleType) %>%
    summarise(weigthedRating = sum(averageRating * numVotes) / sum(numVotes))
```

```{r}
#4(A)
df1 <- basics_ratings_crew[!is.na(basics_ratings_crew$writers),]
df1 <- df1[!is.na(df1$directors),]

df1$director_writer_pair <- paste(df1$directors,"-", df1$writers)
tt <- df1 %>% count(director_writer_pair, sort = TRUE)
ttt <- c(tt[1:10,1])
df2 <- subset(df1, director_writer_pair %in% ttt)

#4(B)
df1$runtimeMinutes <- as.numeric(df1$runtimeMinutes)
temp1 <- group_by(df1, director_writer_pair, titleType, genres)
temp2 <- summarise(temp1, totalVotes = sum(numVotes))
df3 <- summarise(temp1, weightedRating = sum(averageRating * numVotes) / sum(numVotes))

temp3 <- df3 %>% right_join(temp2, by=c("director_writer_pair","titleType", "genres"))

df3_filtered <- filter(temp3, weightedRating == 10)
new_df3_filter <- merge(df3_filtered, tt, by = 'director_writer_pair')
new_filter <- filter(new_df3_filter, n >= 5)
```

```{r}
#tttt <- df1 %>%
#    group_by(director_writer_pair) %>%
#    summarise(weigthedRating = sum(averageRating * numVotes) / sum(numVotes))

#t_final <- merge(tttt, tt, by = 'director_writer_pair')
#t_final <- t_final[with(t_final, order(-n, -weigthedRating)), ]
```